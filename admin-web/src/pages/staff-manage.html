<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Quáº£n lÃ½ nhÃ¢n viÃªn - Admin</title>
    <script src="../services/auth-check.js"></script>
    <link rel="stylesheet" href="../assets/css/MenuManage.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="brand"><span>ğŸ½ï¸</span> VÆ°á»n QuÃª Admin</a>
            </div>
            <ul class="sidebar-menu">
                <li><a href="../index.html"><span class="icon">ğŸ </span> Tá»•ng quan</a></li>
                <li><a href="menu-manage.html"><span class="icon">ğŸ“‹</span> Quáº£n lÃ½ Menu</a></li>
                <li><a href="category-manage.html"><span class="icon">ğŸ“‚</span> Quáº£n lÃ½ Danh má»¥c</a></li>
                <li><a href="staff-manage.html" class="active"><span class="icon">ğŸ‘¥</span> Quáº£n lÃ½ NhÃ¢n viÃªn</a></li>
                <li><a href="invoice.html"><span class="icon">ğŸ§¾</span> HÃ³a Ä‘Æ¡n & Thanh toÃ¡n</a></li>
                <li><a href="statistic.html"><span class="icon">ğŸ“Š</span> BÃ¡o cÃ¡o Thá»‘ng kÃª</a></li>
            </ul>
            <div class="sidebar-footer">&copy; 2026 VÆ°á»n QuÃª Restaurant</div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h1 class="page-title">Quáº£n lÃ½ nhÃ¢n viÃªn</h1>
                <div class="user-profile"><span class="user-name">Quáº£n trá»‹ viÃªn</span>
                    <div class="avatar">A</div>
                </div>
            </header>

            <div class="content-scrollable">
                <div class="data-container">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0;">Danh sÃ¡ch nhÃ¢n viÃªn</h2>
                        <button class="btn btn-primary" onclick="showAddForm()">+ ThÃªm nhÃ¢n viÃªn</button>
                    </div>

                    <table id="staff-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>TÃªn nhÃ¢n viÃªn</th>
                                <th>TÃ i khoáº£n</th>
                                <th>Äá»‹a chá»‰</th>
                                <th>Chá»©c vá»¥</th>
                                <th>Tráº¡ng thÃ¡i</th>
                                <th style="text-align: right;">HÃ nh Ä‘á»™ng</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div id="staff-form"
                        style="display:none; margin-top: 30px; border-top: 1px solid var(--color-neutral-200); padding-top: 30px;">
                        <h2 id="form-title">ThÃªm nhÃ¢n viÃªn</h2>
                        <div class="form-group"><label>TÃªn nhÃ¢n viÃªn:</label><input id="full_name"></div>
                        <div class="form-group"><label>TÃ i khoáº£n:</label><input id="username"></div>
                        <div class="form-group"><label>Máº­t kháº©u:</label><input id="password" type="password"
                                placeholder="Äá»ƒ trá»‘ng náº¿u khÃ´ng muá»‘n Ä‘á»•i"></div>
                        <div class="form-group"><label>CÄƒn cÆ°á»›c cÃ´ng dÃ¢n:</label><input id="cccd"></div>
                        <div class="form-group"><label>Email:</label><input id="email"></div>
                        <div class="form-group"><label>Sá»‘ Ä‘iá»‡n thoáº¡i:</label><input id="phone"></div>
                        <div class="form-group"><label>Äá»‹a chá»‰:</label><input id="address"></div>
                        <div class="form-group">
                            <label>Chá»©c vá»¥:</label>
                            <select id="position"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="STAFF">NhÃ¢n viÃªn</option>
                                <option value="MANAGER">Quáº£n lÃ½</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                            <input id="is_active" type="checkbox" checked style="width: auto;">
                            <label style="margin: 0;">Äang hoáº¡t Ä‘á»™ng</label>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="submitStaff()">LÆ°u láº¡i</button>
                            <button class="btn" style="background: var(--color-neutral-200);"
                                onclick="hideForm()">Há»§y</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="../services/auth.js"></script>
    <script src="../services/admin-api.js"></script>
    <script>
        let editingId = null;
        function fetchStaff() {
            adminApi.getStaff().then(data => {
                if (!data) return;
                const tbody = document.querySelector('#staff-table tbody');
                tbody.innerHTML = '';
                data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                <td>${item.id}</td>
                <td><strong>${item.full_name}</strong></td>
                <td>${item.username}</td>
                <td>${item.address || ''}</td>
                <td>${item.position === 'MANAGE' ? 'Quáº£n lÃ½' : 'NhÃ¢n viÃªn'}</td>
                <td><span style="color: ${item.is_active ? 'var(--color-primary-600)' : '#ef4444'}; font-weight: 600;">${item.is_active ? 'Hoáº¡t Ä‘á»™ng' : 'ÄÃ£ khÃ³a'}</span></td>
                <td style="text-align: right;">
                    <button class="btn" style="padding: 6px 12px; background: var(--color-primary-50); color: var(--color-primary-700); margin-right: 8px;" onclick="editStaff(${item.id})">Sá»­a</button>
                    <button class="btn" style="padding: 6px 12px; background: #fee2e2; color: #ef4444;" onclick="deleteStaff(${item.id})">XÃ³a</button>
                </td>`;
                    tbody.appendChild(tr);
                });
            }).catch(err => console.error('Lá»—i táº£i nhÃ¢n viÃªn:', err));
        }
        function renderPositionOptions(selectedPosition = 'STAFF') {
            const currentUser = authApi.getUser();
            const select = document.getElementById('position');
            select.innerHTML = ''; // Clear current options

            // Always allow creating STAFF
            const opts = [{ value: 'STAFF', label: 'NhÃ¢n viÃªn' }];

            // Only ADMIN can create/assign MANAGE role
            if (currentUser && currentUser.position === 'ADMIN') {
                opts.push({ value: 'MANAGE', label: 'Quáº£n lÃ½' });
            }

            opts.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.innerText = opt.label;
                if (opt.value === selectedPosition) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function showAddForm() {
            editingId = null;
            document.getElementById('form-title').innerText = 'ThÃªm nhÃ¢n viÃªn';
            document.getElementById('staff-form').style.display = '';
            document.querySelectorAll('#staff-form input').forEach(i => i.value = '');

            // Render options based on current user role
            renderPositionOptions('STAFF');

            document.getElementById('is_active').checked = true;
        }

        function editStaff(id) {
            adminApi.getStaff(id).then(item => {
                editingId = id;
                document.getElementById('form-title').innerText = 'Sá»­a nhÃ¢n viÃªn';
                document.getElementById('staff-form').style.display = '';
                document.getElementById('full_name').value = item.full_name;
                document.getElementById('username').value = item.username;
                document.getElementById('password').value = '';
                document.getElementById('cccd').value = item.cccd || '';
                document.getElementById('email').value = item.email || '';
                document.getElementById('phone').value = item.phone || '';
                document.getElementById('address').value = item.address || '';

                // Render options (ADMIN sees all, MANAGE only sees limited if they were somehow editing a manager? 
                // Checks should be stricter but for now this fits the requirement)
                renderPositionOptions(item.position || 'STAFF');

                document.getElementById('is_active').checked = item.is_active == 1;
            });
        }

        function hideForm() {
            document.getElementById('staff-form').style.display = 'none';
        }
        function submitStaff() {
            const data = {
                full_name: document.getElementById('full_name').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                cccd: document.getElementById('cccd').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                position: document.getElementById('position').value,
                is_active: document.getElementById('is_active').checked ? 1 : 0
            };
            if (editingId) {
                adminApi.updateStaff(editingId, data).then(res => {
                    if (res.success) {
                        fetchStaff();
                        hideForm();
                    } else alert(res.message);
                });
            } else {
                adminApi.createStaff(data).then(res => {
                    if (res.success) {
                        fetchStaff();
                        hideForm();
                    } else alert(res.message);
                });
            }
        }
        function deleteStaff(id) {
            if (confirm('XÃ³a nhÃ¢n viÃªn nÃ y?')) {
                adminApi.deleteStaff(id).then(fetchStaff);
            }
        }
        fetchStaff();
    </script>
</body>

</html>