<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω nh√¢n vi√™n - Admin</title>
    <script src="../services/auth-check.js"></script>
    <link rel="stylesheet" href="../assets/css/MenuManage.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="brand"><span>üçΩÔ∏è</span> V∆∞·ªùn Qu√™ Admin</a>
            </div>
            <ul class="sidebar-menu">
                <li><a href="../index.html"><span class="icon">üè†</span> T·ªïng quan</a></li>
                <li><a href="menu-manage.html"><span class="icon">üìã</span> Qu·∫£n l√Ω Menu</a></li>
                <li><a href="category-manage.html"><span class="icon">üìÇ</span> Qu·∫£n l√Ω Danh m·ª•c</a></li>
                <li><a href="staff-manage.html" class="active"><span class="icon">üë•</span> Qu·∫£n l√Ω Nh√¢n vi√™n</a></li>
                <li><a href="invoice.html"><span class="icon">üßæ</span> H√≥a ƒë∆°n & Thanh to√°n</a></li>
                <li><a href="statistic.html"><span class="icon">üìä</span> B√°o c√°o Th·ªëng k√™</a></li>
            </ul>
            <div class="sidebar-footer">&copy; 2026 V∆∞·ªùn Qu√™ Restaurant</div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h1 class="page-title">Qu·∫£n l√Ω nh√¢n vi√™n</h1>
                <div class="user-profile"><span class="user-name">Qu·∫£n tr·ªã vi√™n</span>
                    <div class="avatar">A</div>
                </div>
            </header>

            <div class="content-scrollable">
                <div class="data-container">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0;">Danh s√°ch nh√¢n vi√™n</h2>
                        <button class="btn btn-primary" onclick="showAddForm()">+ Th√™m nh√¢n vi√™n</button>
                    </div>

                    <table id="staff-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n nh√¢n vi√™n</th>
                                <th>T√†i kho·∫£n</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th>Ch·ª©c v·ª•</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th style="text-align: right;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div id="staff-form"
                        style="display:none; margin-top: 30px; border-top: 1px solid var(--color-neutral-200); padding-top: 30px;">
                        <h2 id="form-title">Th√™m nh√¢n vi√™n</h2>
                        <div class="form-group"><label>T√™n nh√¢n vi√™n:</label><input id="full_name"></div>
                        <div class="form-group"><label>T√†i kho·∫£n:</label><input id="username"></div>
                        <div class="form-group"><label>M·∫≠t kh·∫©u:</label><input id="password" type="password"
                                placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi"></div>
                        <div class="form-group"><label>CƒÉn c∆∞·ªõc c√¥ng d√¢n:</label><input id="cccd"></div>
                        <div class="form-group"><label>Email:</label><input id="email"></div>
                        <div class="form-group"><label>S·ªë ƒëi·ªán tho·∫°i:</label><input id="phone"></div>
                        <div class="form-group"><label>ƒê·ªãa ch·ªâ:</label><input id="address"></div>
                        <div class="form-group">
                            <label>Ch·ª©c v·ª•:</label>
                            <select id="position"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                <option value="STAFF">Nh√¢n vi√™n</option>
                                <option value="MANAGER">Qu·∫£n l√Ω</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                            <input id="is_active" type="checkbox" checked style="width: auto;">
                            <label style="margin: 0;">ƒêang ho·∫°t ƒë·ªông</label>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="submitStaff()">L∆∞u l·∫°i</button>
                            <button class="btn" style="background: var(--color-neutral-200);"
                                onclick="hideForm()">H·ªßy</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="../services/auth.js"></script>
    <script src="../services/admin-api.js"></script>
    <script>
        let editingId = null;
        function fetchStaff() {
            adminApi.getStaff().then(data => {
                if (!data) return;

                // Security Filter: Only ADMIN can see other ADMINs
                const currentUser = authApi.getUser();
                if (currentUser && currentUser.position !== 'ADMIN') {
                    data = data.filter(item => item.position !== 'ADMIN');
                }

                // Sort: Active first, then Inactive (0 at bottom)
                // Use a stable sort if needed, but simple sort works here
                data.sort((a, b) => b.is_active - a.is_active);

                const tbody = document.querySelector('#staff-table tbody');
                tbody.innerHTML = '';
                data.forEach(item => {
                    const isActive = item.is_active == 1;
                    const tr = document.createElement('tr');

                    let roleDisplay = 'Nh√¢n vi√™n';
                    if (item.position === 'ADMIN') roleDisplay = 'Qu·∫£n tr·ªã vi√™n';
                    else if (item.position === 'MANAGE') roleDisplay = 'Qu·∫£n l√Ω';

                    // Action Buttons: View | Edit | Lock/Unlock | Delete
                    const lockBtn = isActive
                        ? `<button class="btn" style="padding: 6px 12px; background: #fff7ed; color: #c2410c; margin-right: 8px;" onclick="toggleStatus(${item.id}, 0)" title="Kh√≥a t√†i kho·∫£n">Kh√≥a</button>`
                        : `<button class="btn" style="padding: 6px 12px; background: #ecfdf5; color: #047857; margin-right: 8px;" onclick="toggleStatus(${item.id}, 1)" title="M·ªü kh√≥a t√†i kho·∫£n">M·ªü</button>`;

                    tr.innerHTML = `
                <td>${item.id}</td>
                <td><strong>${item.full_name}</strong></td>
                <td>${item.username}</td>
                <td>${item.address || ''}</td>
                <td><span class="badge ${item.position}">${roleDisplay}</span></td>
                <td><span style="color: ${isActive ? 'var(--color-primary-600)' : '#ef4444'}; font-weight: 600;">${isActive ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ kh√≥a'}</span></td>
                <td style="text-align: right; white-space: nowrap;">
                    <button class="btn" style="padding: 6px 12px; background: #e0f2fe; color: #0369a1; margin-right: 8px;" onclick="viewStaff(${item.id})">Xem</button>
                    ${lockBtn}
                    <button class="btn" style="padding: 6px 12px; background: var(--color-primary-50); color: var(--color-primary-700); margin-right: 8px;" onclick="editStaff(${item.id})">S·ª≠a</button>
                    <button class="btn" style="padding: 6px 12px; background: #fee2e2; color: #ef4444;" onclick="deleteStaff(${item.id})">X√≥a</button>
                </td>`;
                    tbody.appendChild(tr);
                });
            }).catch(err => console.error('L·ªói t·∫£i nh√¢n vi√™n:', err));
        }

        function viewStaff(id) {
            adminApi.getStaff(id).then(item => {
                let roleDisplay = 'Nh√¢n vi√™n';
                if (item.position === 'ADMIN') roleDisplay = 'Qu·∫£n tr·ªã vi√™n';
                else if (item.position === 'MANAGE') roleDisplay = 'Qu·∫£n l√Ω';

                const info = `
                    <p><strong>H·ªç t√™n:</strong> ${item.full_name}</p>
                    <p><strong>T√†i kho·∫£n:</strong> ${item.username}</p>
                    <p><strong>Ch·ª©c v·ª•:</strong> ${roleDisplay}</p>
                    <p><strong>Tr·∫°ng th√°i:</strong> ${item.is_active == 1 ? 'ƒêang ho·∫°t ƒë·ªông' : 'ƒê√£ kh√≥a'}</p>
                    <p><strong>CCCD:</strong> ${item.cccd || 'Tr·ªëng'}</p>
                    <p><strong>Email:</strong> ${item.email || 'Tr·ªëng'}</p>
                    <p><strong>SƒêT:</strong> ${item.phone || 'Tr·ªëng'}</p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> ${item.address || 'Tr·ªëng'}</p>
                    <p><strong>Ng√†y t·∫°o:</strong> ${item.created_at || 'N/A'}</p>
                `;
                showModal('Th√¥ng tin chi ti·∫øt', info);
            });
        }

        // Simple Custom Modal Logic
        function showModal(title, content) {
            // Remove existing modal if any
            const existing = document.getElementById('custom-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'custom-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 24px; border-radius: 12px; width: 400px; max-width: 90%;">
                    <h3 style="margin-top: 0; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 12px;">${title}</h3>
                    <div>${content}</div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="document.getElementById('custom-modal').remove()">ƒê√≥ng</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function toggleStatus(id, newStatus) {
            const action = newStatus === 1 ? 'm·ªü kh√≥a' : 'kh√≥a';
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action} t√†i kho·∫£n n√†y?`)) {
                adminApi.toggleStaffStatus(id, newStatus).then(res => {
                    if (res.success) {
                        fetchStaff();
                    } else alert(res.message);
                });
            }
        }

        function deleteStaff(id) {
            if (confirm('C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n nh√¢n vi√™n.\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?')) {
                adminApi.deleteStaff(id).then(res => {
                    if (res.success) {
                        fetchStaff();
                    } else alert(res.message);
                });
            }
        }
        function renderPositionOptions(selectedPosition = 'STAFF') {
            const currentUser = authApi.getUser();
            const select = document.getElementById('position');
            select.innerHTML = ''; // Clear current options

            // Always allow creating STAFF
            const opts = [{ value: 'STAFF', label: 'Nh√¢n vi√™n' }];

            // Only ADMIN can create/assign MANAGE role
            if (currentUser && currentUser.position === 'ADMIN') {
                opts.push({ value: 'MANAGE', label: 'Qu·∫£n l√Ω' });
            }

            opts.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.innerText = opt.label;
                if (opt.value === selectedPosition) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function showAddForm() {
            editingId = null;
            document.getElementById('form-title').innerText = 'Th√™m nh√¢n vi√™n';
            document.getElementById('staff-form').style.display = '';
            document.querySelectorAll('#staff-form input').forEach(i => i.value = '');

            // Render options based on current user role
            renderPositionOptions('STAFF');

            document.getElementById('is_active').checked = true;
        }

        function editStaff(id) {
            adminApi.getStaff(id).then(item => {
                editingId = id;
                document.getElementById('form-title').innerText = 'S·ª≠a nh√¢n vi√™n';
                document.getElementById('staff-form').style.display = '';
                document.getElementById('full_name').value = item.full_name;
                document.getElementById('username').value = item.username;
                document.getElementById('password').value = '';
                document.getElementById('cccd').value = item.cccd || '';
                document.getElementById('email').value = item.email || '';
                document.getElementById('phone').value = item.phone || '';
                document.getElementById('address').value = item.address || '';

                // Render options (ADMIN sees all, MANAGE only sees limited if they were somehow editing a manager? 
                // Checks should be stricter but for now this fits the requirement)
                renderPositionOptions(item.position || 'STAFF');

                document.getElementById('is_active').checked = item.is_active == 1;
            });
        }

        function hideForm() {
            document.getElementById('staff-form').style.display = 'none';
        }
        function submitStaff() {
            const data = {
                full_name: document.getElementById('full_name').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                cccd: document.getElementById('cccd').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                position: document.getElementById('position').value,
                is_active: document.getElementById('is_active').checked ? 1 : 0
            };
            if (editingId) {
                adminApi.updateStaff(editingId, data).then(res => {
                    if (res.success) {
                        fetchStaff();
                        hideForm();
                    } else alert(res.message);
                });
            } else {
                adminApi.createStaff(data).then(res => {
                    if (res.success) {
                        fetchStaff();
                        hideForm();
                    } else alert(res.message);
                });
            }
        }

        // ... existing functions ...

        // User Profile & Dropdown Logic
        document.addEventListener('DOMContentLoaded', () => {
            const user = authApi.getUser();
            if (user) {
                const nameEl = document.querySelector('.user-name');
                const avatarEl = document.querySelector('.avatar');
                if (nameEl) nameEl.textContent = user.full_name;
                if (avatarEl) avatarEl.textContent = user.full_name.charAt(0).toUpperCase();
            }

            // Profile Click
            const profile = document.querySelector('.user-profile');
            if (profile) {
                profile.style.cursor = 'pointer';
                profile.style.position = 'relative';

                // Create Dropdown
                const dropdown = document.createElement('div');
                dropdown.className = 'profile-dropdown';
                dropdown.innerHTML = `
                    <div class="dropdown-item" onclick="authApi.logout()">
                        <span style="font-size: 1.2em">üö™</span> ƒêƒÉng xu·∫•t
                    </div>
                `;
                profile.appendChild(dropdown);

                profile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('show');
                });

                document.addEventListener('click', () => {
                    dropdown.classList.remove('show');
                });
            }
        });

        fetchStaff();
    </script>
    <style>
        /* Dropdown Styles */
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            min-width: 200px;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .profile-dropdown.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--color-neutral-700);
            border-radius: 8px;
            transition: background 0.2s;
            font-weight: 500;
        }

        .dropdown-item:hover {
            background: var(--color-neutral-100);
            color: var(--color-primary-600);
        }
    </style>
</body>

</html>