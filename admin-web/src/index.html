<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - V∆∞·ªùn Qu√™ Admin</title>
    <script src="services/auth-check.js"></script>
    <link rel="stylesheet" href="assets/css/MenuManage.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="brand">
                    <span>üçΩÔ∏è</span> V∆∞·ªùn Qu√™ Admin
                </a>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="index.html" class="active">
                        <span class="icon">üè†</span> T·ªïng quan
                    </a>
                </li>
                <li>
                    <a href="pages/menu-manage.html">
                        <span class="icon">üìã</span> Qu·∫£n l√Ω Menu
                    </a>
                </li>
                <li>
                    <a href="pages/category-manage.html">
                        <span class="icon">üìÇ</span> Qu·∫£n l√Ω Danh m·ª•c
                    </a>
                </li>
                <li>
                    <a href="pages/staff-manage.html">
                        <span class="icon">üë•</span> Qu·∫£n l√Ω Nh√¢n vi√™n
                    </a>
                </li>
                <li>
                    <a href="pages/invoice.html">
                        <span class="icon">üßæ</span> H√≥a ƒë∆°n & Thanh to√°n
                    </a>
                </li>
                <li>
                    <a href="pages/statistic.html">
                        <span class="icon">üìä</span> B√°o c√°o Th·ªëng k√™
                    </a>
                </li>
            </ul>
            <div class="sidebar-footer">
                &copy; 2026 V∆∞·ªùn Qu√™ Restaurant
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <h1 class="page-title">B·∫£ng ƒëi·ªÅu khi·ªÉn</h1>
                <div class="user-profile">
                    <span class="user-name">Qu·∫£n tr·ªã vi√™n</span>
                    <div class="avatar">A</div>
                </div>
            </header>

            <div class="content-scrollable">
                <div class="welcome-banner">
                    <h2>Ch√†o m·ª´ng tr·ªü l·∫°i! üëã</h2>
                    <p>H·ªá th·ªëng hi·ªán t·∫°i ƒëang ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh. B·∫°n c√≥ th·ªÉ theo d√µi v√† qu·∫£n l√Ω nh√† h√†ng t·∫°i ƒë√¢y.</p>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-icon">üìã</div>
                        <h3>Qu·∫£n l√Ω Menu</h3>
                        <p>T√πy ch·ªânh danh s√°ch m√≥n ƒÉn, gi√° c·∫£ v√† tr·∫°ng th√°i c√≤n m√≥n.</p>
                        <a href="pages/menu-manage.html" class="card-action">Qu·∫£n l√Ω ngay &rarr;</a>
                    </div>

                    <div class="card">
                        <div class="card-icon">üë•</div>
                        <h3>Nh√¢n vi√™n</h3>
                        <p>X·ª≠ l√Ω th√¥ng tin nh√¢n s·ª±, ph√¢n quy·ªÅn truy c·∫≠p h·ªá th·ªëng.</p>
                        <a href="pages/staff-manage.html" class="card-action">Chi ti·∫øt &rarr;</a>
                    </div>

                    <div class="card">
                        <div class="card-icon">üßæ</div>
                        <h3>Giao d·ªãch</h3>
                        <p>T·ªïng h·ª£p c√°c h√≥a ƒë∆°n v√† l·ªãch s·ª≠ thanh to√°n t·ª´ kh√°ch h√†ng.</p>
                        <a href="pages/invoice.html" class="card-action">Xem h√≥a ƒë∆°n &rarr;</a>
                    </div>

                    <div class="card">
                        <div class="card-icon">üìä</div>
                        <h3>Th·ªëng k√™</h3>
                        <p>B√°o c√°o doanh thu v√† ph√¢n t√≠ch hi·ªáu qu·∫£ kinh doanh.</p>
                        <a href="pages/statistic.html" class="card-action">Xem b√°o c√°o &rarr;</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters {
            display: flex;
            gap: 5px;
        }

        .filter-btn {
            background: #f0f0f0;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .filter-btn.active {
            background: #2e7d32;
            color: white;
        }

        @media (max-width: 900px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="services/admin-api.js"></script>
    <script>
        let topDishesChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Setup chart UI
            const dashboardGrid = document.querySelector('.dashboard-grid');
            const chartsSection = document.createElement('div');
            chartsSection.className = 'charts-container';
            chartsSection.innerHTML = `
                <div class="chart-card">
                    <h3>T·ª∑ l·ªá Danh m·ª•c b√°n ra</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Top 3 M√≥n ƒÉn b√°n ch·∫°y</h3>
                        <div class="filters">
                            <button class="filter-btn active" onclick="loadTopDishes('day', this)">Ng√†y</button>
                            <button class="filter-btn" onclick="loadTopDishes('week', this)">Tu·∫ßn</button>
                            <button class="filter-btn" onclick="loadTopDishes('month', this)">Th√°ng</button>
                            <button class="filter-btn" onclick="loadTopDishes('year', this)">NƒÉm</button>
                        </div>
                    </div>
                    <canvas id="dishesChart"></canvas>
                </div>
            `;
            // Insert after dashboard grid
            dashboardGrid.parentNode.insertBefore(chartsSection, dashboardGrid.nextSibling);

            loadCharts();
            loadTopDishes('day'); // Load default
        });

        async function loadCharts() {
            try {
                // Fetch stats and menu for category matching
                const [stats, menu] = await Promise.all([
                    adminApi.getStatistics(), // Default fetch (usually logic is backend heavy, but here relying on what's available)
                    adminApi.getMenu()
                ]);

                if (stats && menu) {
                    renderCategoryChart(stats, menu);
                }
            } catch (err) {
                console.error('L·ªói t·∫£i bi·ªÉu ƒë·ªì:', err);
            }
        }

        async function loadTopDishes(type, btnElement) {
            // UI Update
            if (btnElement) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            // Calculate Date Range
            const now = new Date();
            let from = new Date();
            let to = new Date();

            if (type === 'day') {
                from = now; // Today
            } else if (type === 'week') {
                const day = now.getDay() || 7;
                from.setDate(now.getDate() - day + 1);
            } else if (type === 'month') {
                from.setDate(1);
            } else if (type === 'year') {
                from.setMonth(0, 1);
            }

            // Allow for slightly explicit 'from' date formatting YYYY-MM-DD
            const fmt = d => d.toISOString().split('T')[0];

            try {
                const stats = await adminApi.getStatistics({ from: fmt(from), to: fmt(to) });
                if (stats && stats.top_items) {
                    renderTopDishesChart(stats.top_items);
                }
            } catch (e) {
                console.error("L·ªói t·∫£i top m√≥n:", e);
            }
        }

        function renderCategoryChart(stats, menu) {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            // Process Aggregation
            // 1. Map Menu IDs to Category Names
            const categoryMap = {}; // itemId -> categoryName
            menu.forEach(item => {
                categoryMap[item.id] = item.category_name || 'Kh√°c';
            });

            // 2. Aggregate from Sold Items
            // Note: stats.top_items might only be TOP items. 
            // Ideally we need specific category stats. If not available, we estimate from top items provided.
            // OR we use stats.orders if it had category info. 
            // Assuming top_items covers enough ground for a "demo" or we note it's based on top items.
            // BETTER: If stats object has a breakdown. It does not seem so from the viewed file.
            // Let's use top_items as a proxy for "Sold Items Distribution".

            const catCounts = {};
            stats.top_items.forEach(item => {
                const catName = categoryMap[item.menu_item_id] || 'Kh√°c';
                catCounts[catName] = (catCounts[catName] || 0) + parseInt(item.total_quantity);
            });

            const labels = Object.keys(catCounts);
            const data = Object.values(catCounts);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                        ]
                    }]
                }
            });
        }

        function renderTopDishesChart(items) {
            const ctx = document.getElementById('dishesChart').getContext('2d');

            // Take top 3
            const top3 = items.slice(0, 3);
            const labels = top3.map(i => i.menu_item_name);
            const data = top3.map(i => parseInt(i.total_quantity));

            if (topDishesChart) {
                topDishesChart.destroy();
            }

            topDishesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng b√°n',
                        data: data,
                        backgroundColor: '#2e7d32'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>
</body>

</html>